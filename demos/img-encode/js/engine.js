var animationFunc,AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,audioContext=audioContext||new AudioContext,audio=new Audio,width=800,height=600,canvas=document.getElementById("spectrum-canvas"),ctx=canvas.getContext("2d"),speed=2,fftsize=2048,tempCanvas=document.createElement("canvas"),input=input||audioContext.createMediaElementSource(audio),analyser=audioContext.createAnalyser();function showLoading(){$("#waitScreen").removeClass("invisible")}function hideLoading(){$("#waitScreen").addClass("invisible")}function loadCanvas(e){let t=new FileReader,n=document.getElementById("canvas"),a=n.getContext("2d"),i=new Image;t.readAsDataURL(e),t.onload=function(e){i.src=e.target.result,i.onload=function(){n.width=i.width,n.height=i.height,a.drawImage(i,0,0,i.width,i.height)},i.onerror=function(){alert("Invalid file: "+file.type)}}}function loadCanvasFromExampleFiles(e){let t=document.getElementById("canvas"),n=t.getContext("2d"),a=new Image;a.src=e,a.onload=function(){t.width=a.width,t.height=a.height,n.drawImage(a,0,0,a.width,a.height)},a.onerror=function(){alert("Invalid file: "+e)}}function getImageData(){let e=document.getElementById("canvas"),t=e.getContext("2d").getImageData(0,0,e.width,e.height),n=t.height,a=t.width,i=parseFloat($("#lengthInSeconds").val()),o=[],d=0,l=[],r=Math.round(44100*i),s=Math.floor(r/a),c=2e4/n;for(let e=0;e<r;e++){let i=0,l=Math.floor(e/s);for(let o=0;o<n;o+=2){let d=4*(o*a+l),r=t.data[d],s=t.data[d+1],h=r+t.data[d+2]+s,u=Math.pow(100*h/765,2),g=Math.round(c*(n-o+1));i+=Math.floor(u*Math.cos(6.28*g*e/44100))}o.push(i),Math.abs(i)>d&&(d=Math.abs(i))}for(let e=0;e<o.length;e++)l.push(32767*o[e]/d);let h=new RIFFWAVE;h.header.sampleRate=44100,h.header.numChannels=1,h.header.bitsPerSample=16,h.Make(l);let u=dataURItoBlob(h.dataURI);hideLoading();window.URL.createObjectURL(u);$("#previewPage").removeClass("invisible"),$("#download-link-container").on("click",()=>saveAs(u,"result.wav"));let g=document.getElementById("previewPage").getBoundingClientRect();window.scrollTo(0,g.y+window.scrollY),audio.src=h.dataURI,audio.controls=!0,audio.onpause=(()=>{window.cancelAnimationFrame(animationFunc)}),audio.addEventListener("ended",()=>{window.cancelAnimationFrame(animationFunc)}),audio.id="audioPlayer",document.getElementById("audioControls").appendChild(audio),audio.onplay=(()=>{render()}),(analyser=audioContext.createAnalyser()).smoothingTimeConstant=.3,analyser.fftSize=1024,input.connect(analyser),input.connect(audioContext.destination),ctx.clearRect(0,0,canvas.width,canvas.height)}function dataURItoBlob(e){let t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);let n=e.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(t.length);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);return new Blob([a],{type:n})}function render(){let e=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(e),tempCanvas.width=width,tempCanvas.height=height,tempCanvas.getContext("2d").drawImage(canvas,0,0,width,height);for(let t=0;t<e.length;t++){let n=e[t];ctx.fillStyle=`rgb(${n}, ${n}, ${n})`;let a=t/e.length,i=Math.round(a*height);ctx.fillRect(width-speed,height-i,speed,speed)}ctx.translate(-speed,0),ctx.drawImage(tempCanvas,0,0,width,height,0,0,width,height),ctx.setTransform(1,0,0,1,0,0),animationFunc=requestAnimationFrame(render.bind(this))}input.connect(analyser),input.connect(audioContext.destination);